<html>
    <head >
            <meta charset="utf-8" />
            <title>Służba</title>
            
            <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
            
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
            <!-- Latest compiled and minified CSS -->
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

            <!-- Optional theme -->
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

            <!-- Latest compiled and minified JavaScript -->
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
             <link rel="stylesheet" href="jquery-ui-1.12.1/jquery-ui.min.css">
            <link rel="stylesheet" href="main.css" /> 
    </head>
    <body ng-app="Service" >
        <header>

        </header>
        <main>
            
            <table ng-controller = "table" >
                <tr>
                    <th>
                        Id
                    </th>
                    <th>
                        Imie
                    </th>
                    <th>
                        Nazwisko
                    </th>
                    <th>
                        Data Urodzenia
                    </th>
                    <th>
                        Funkcja
                    </th>
                    <th>
                        Doświadczenie
                    </th>
                </tr>
                <tr ng-repeat = "x in json " class="data" id="{{x.id}}">
                    <td>
                        {{x.id}}
                    </td>
                    <td>
                        {{x.firstName}}
                    </td>
                    <td>
                        {{x.lastName}}
                    </td>
                    <td>
                        {{x.dateOfBirth}}
                    </td>
                    <td>
                        {{x.function}}
                    </td>
                    <td>
                        {{x.experience}}
                    </td>
                </tr>
            </table>
        </main>
        <button onclick="sorting('id')">Sort Id</button>
        <button onclick="sorting('firstName')">Sort Imie</button>
        <button onclick="sorting('lastName')">Sort Nazwisko</button>
        <button onclick="sorting('dateOfBirth')">Sort data</button>
        <button onclick="sorting('serviceFunction')">Sort data</button>
        <button onclick="sorting('experience')">Sort exp</button>
        <br />
        <input type="text" oninput="filtring()" id="wantedFirstName">
        <input type="text" oninput="filtring()" id="wantedLastName">
        <div ng-controller="selectCtrl">
        <select  ng-model="serviceFunctions"  ng-options="x for x in servicesFunctions" id="servicesFunctionsOptions">
        </select>
        <select  ng-model="experiencesOptions"  ng-options="x for x in experiences" id="experiencesOptions">      
        </select>
        </div>
        <button onclick="resetDatepickers()">Reset</button>
        <div id="datepicker"></div>
        <div id="datepicker2"></div>
        <script src="jquery-ui-1.12.1/jquery-ui.min.js"></script>
        <script>
            $( function() {
                 $( "#datepicker" ).datepicker({
                        minDate: new Date(1970 , 1 - 1, 1),
                        defaultDate: new Date(1980 , 1 - 1, 1),
                        changeMonth: true,
                        changeYear: true,
                        showButtonPanel: true
                        })
                 .on("change",function(){
                     dateOne = new Date(this.value.substring(6,10),Number(this.value.substring(0,2))-1,Number(this.value.substring(3,5)),0,0,0);
                     if(dateTwo != null){
                        filtring();
                     }
                 });
                  $( "#datepicker2" ).datepicker({
                        minDate: new Date(1970 , 1 - 1, 1),
                        defaultDate: new Date(1980 , 1 - 1, 1),
                        changeMonth: true,
                        changeYear: true,
                        showButtonPanel: true
                        })
                 .on("change",function(){
                     dateTwo = new Date(this.value.substring(6,10),Number(this.value.substring(0,2))-1,Number(this.value.substring(3,5)),0,0,0);
                     if(dateOne != null){
                        filtring();
                     }
                 });
            });
        function resetDatepickers(){
             $( "#datepicker" ).datepicker( "destroy"  );
             $( "#datepicker" ).datepicker({
                        minDate: new Date(1970 , 1 - 1, 1),
                        defaultDate: new Date(1980 , 1 - 1, 1),
                        changeMonth: true,
                        changeYear: true,
                        showButtonPanel: true
                        });
             $( "#datepicker2" ).datepicker( "destroy"  );
             $( "#datepicker2" ).datepicker({
                        minDate: new Date(1970 , 1 - 1, 1),
                        defaultDate: new Date(1980 , 1 - 1, 1),
                        changeMonth: true,
                        changeYear: true,
                        showButtonPanel: true
                        });
            for(var i = 0;i < persons.length;i++){
                $( "#" + persons[i].id ).removeClass("fadeByTime");
            }
        }
        //variable
        var appName = "Service";
        var app = angular.module(appName, []);
        var sort = [];
        var persons = [];
        var tableRows = [];
        var idClasses = [];
        var dateOne = null;
        var dateTwo = null;
        
        //iniciation of variables
        sort["id"] = 0;
        sort["firstName"] = 0;
        sort["lastName"] = 0;
        sort["dateOfBirth"] = 0;
        sort["serviceFunction"] = 0;
        sort["experience"] = 0;
        $.getJSON("https://raw.githubusercontent.com/ElderDrop/Projekt-Na-Sta--/master/sluzba.json",function( json ){
            for( var i = 0; i < json.length;i++ ){
                var x = json[i];
                persons.push( new Person(x.id,x.firstName,x.lastName,x.dateOfBirth,x.function,x.experience) );
            }
        });
        //controllers
        //This controller creats table
        app.controller("table",function($scope,$http){
            //loads json file from github
           $http.get("https://raw.githubusercontent.com/ElderDrop/Projekt-Na-Sta--/master/sluzba.json").then(function(data){
               var list = [];
               var begin = 0;
               var pagination = 12;
               for(var i = begin; i < pagination;i++){
                   list.push( data.data[i] );
               }
              return $scope.json = list;
           });    
        });
        
        app.controller("selectCtrl",function($scope,$http){
            $http.get("https://raw.githubusercontent.com/ElderDrop/Projekt-Na-Sta--/master/sluzba.json").then(function(data){
               var servicesFunctions = [];
               var experiences = [];
               servicesFunctions.push("none");
               experiences.push("none");
               var persons = [];
               for(var i = 0; i < data.data.length;i++){
                    if(!isInside(data.data[i].experience,experiences)){
                        experiences.push(data.data[i].experience);
                    };
                   if(!isInside(data.data[i].function.trim(),servicesFunctions))
                        servicesFunctions.push(data.data[i].function.trim());
                    }; 
               $scope.serviceFunctions = servicesFunctions[0];
               $scope.experiencesOptions = experiences[0];
               $scope.experiences = experiences;
            return $scope.servicesFunctions = servicesFunctions;
            });
        });

        //functions
        function filtring(){
            
                var data = $(".data").clone();
                if(dateTwo < dateOne){
                    var tmp = dateOne;
                    dateOne = dateTwo;
                    dateTwo = tmp;
                }
                for( var i = 0; i < data.length; i++ ){
                    var parent = data.get(i);
                    var person = new Person( Number(parent.children[0].innerText.trim()),parent.children[1].innerText.trim(),parent.children[2].innerText.trim(),parent.children[3].innerText.trim(),parent.children[4].innerText.trim(),parent.children[5].innerText.trim());
                    var value = $("#experiencesOptions").val();
                    value = value.substring(7,value.length)
                    if(value == "none"){
                        if(!$( "#" + person.id ).hasClass(/fadeBy/)){
                            if( $( "#" + person.id ).hasClass("fadeByExp") ){
                                $( "#" + person.id ).fadeIn();
                            }
                            $( "#" + person.id ).removeClass("fadeByExp");
                         }
                    }else{
                        if( person.experience != value ){
                            $( "#" + person.id ).fadeOut().addClass("fadeByExp");
                        }else{
                            if(!$( "#" + person.id ).hasClass(/fadeBy/)){
                                $( "#" + person.id ).fadeIn();
                                $( "#" + person.id ).removeClass("fadeByExp");
                            }
                        }
                    
                    }

                    value = $( "#servicesFunctionsOptions" ).val();
                    value = value.substring(7,value.length);
                    
                    if( value == "none" ){
                      if(!$( "#" + person.id ).hasClass(/fadeBy/)){
                            if( $( "#" + person.id ).hasClass("fadeByServ") ){
                                $( "#" + person.id ).fadeIn();
                            }
                            $( "#" + person.id ).removeClass("fadeByServ");
                         }
                    }else{
                        if( person.serviceFunction != value ){
                            $( "#" + person.id ).fadeOut().addClass("fadeByServ");
                        }else{
                            if(!$( "#" + person.id ).hasClass(/fadeBy/)){
                                $( "#" + person.id ).fadeIn();
                                $( "#" + person.id ).removeClass("fadeByServ");
                            }
                        }
                    
                    }

                    value = $("#wantedFirstName").val().trim();
                    if( value.length == 0 ){
                        $( "#" + person.id ).removeClass("fadeByFirstName");
                        if(!$( "#" + person.id ).hasClass(/fadeBy/)){
                                $( "#" + person.id ).fadeIn();
                            }
                    }
                    if( value.length > 0 ){
                        if( person.firstName.includes(value) ){
                            if( !$( "#" + person.id ).hasClass(/fadeBy/) ){
                                $( "#" + person.id ).fadeIn();
                            }
                            $( "#" + person.id ).removeClass("fadeByFirstName");
                        }else{
                            $( "#" + person.id ).fadeOut().addClass("fadeByFirstName");
                        }
                    }

                    value = $("#wantedLastName").val().trim();
                    if( value.length == 0 ){
                        $( "#" + person.id ).removeClass("fadeByLastName");
                        if(!$( "#" + person.id ).hasClass(/fadeBy/)){
                                $( "#" + person.id ).fadeIn();
                            }
                    }
                    if( value.length > 0 ){
                        if( person.lastName.includes(value) ){
                            if(!$( "#" + person.id ).hasClass(/fadeBy/)){
                                $( "#" + person.id ).fadeIn();
                            }
                            $( "#" + person.id ).removeClass("fadeByLastName");
                        }else{
                            $( "#" + person.id ).fadeOut().addClass("fadeByLastName");
                        }
                    }
                    var tmpDate = new Date(person.date.getFullYear(),person.date.getMonth(),person.date.getDay(),0,0,0,0);
                    if(dateOne.getTime() <= tmpDate.getTime() && dateTwo.getTime() >= tmpDate.getTime()){
                            if(!$( "#" + person.id ).hasClass(/fadeBy/)){
                                $( "#" + person.id ).fadeIn();
                            }
                            $( "#" + person.id ).removeClass("fadeByTime");
                        }else{
                            $( "#" + person.id ).fadeOut().addClass("fadeByTime");
                        }
                    
                    
                    
                    
                }
        }
        
        function isInside(str, tab){
            for( var i = 0; i < tab.length;i++ ){
                if( tab[i] == str ){
                    return true;
                }
            }
            return false;
        }
        $("#experiencesOptions").change(function(){
            filtring();
        });
        $("#servicesFunctionsOptions").change(function(){
            filtring();
        });

        
        
        //1 asc, 2 desc, 0 none
        function sorting(typeOfSort){
            incrementSort(typeOfSort)
            if( typeOfSort == "id" ){
                if( sort[typeOfSort] == 1 ){
                     persons.sort(function( a, b ){return a.id - b.id});
                }
                if( sort[typeOfSort] == 2 ){
                     persons.sort(function( a, b ){return b.id - a.id});
                }
            }        
            if( typeOfSort == "firstName" ){
                if( sort[typeOfSort] == 1 ){
                    persons.sort(function( a, b ){return a.lastName.localeCompare(b.lastName)});
                    persons.sort(function( a, b ){return a.firstName.localeCompare(b.firstName)});
                }
                if( sort[typeOfSort] == 2 ){
                    persons.sort(function( a, b ){return b.lastName.localeCompare(a.lastName)});
                    persons.sort(function( a, b ){return b.firstName.localeCompare(a.firstName)});
                }
            }
            if( typeOfSort == "firstName" ){
                if( sort[typeOfSort] == 1 ){
                    persons.sort(function( a, b ){return a.lastName.localeCompare(b.lastName)});
                    persons.sort(function( a, b ){return a.firstName.localeCompare(b.firstName)});
                }
                if( sort[typeOfSort] == 2 ){
                    persons.sort(function( a, b ){return b.lastName.localeCompare( a.lastName )});
                    persons.sort(function( a, b ){return b.firstName.localeCompare( a.firstName )});
                }
            }
            if( typeOfSort == "lastName" ){
                if( sort[typeOfSort] == 1 ){
                    persons.sort( function( a, b ){return a.firstName.localeCompare(b.firstName)});
                    persons.sort( function( a, b ){return a.lastName.localeCompare(b.lastName)});
                }
                if( sort[typeOfSort] == 2 ){              
                    persons.sort( function( a, b ){return b.firstName.localeCompare(a.firstName)});
                    persons.sort( function( a, b ){return b.lastName.localeCompare(a.lastName)});
                }
            }
            if( typeOfSort == "dateOfBirth" ){
                if( sort[typeOfSort] == 1 ){
                    persons.sort( function( a, b ){ return a.date.getTime() - b.date.getTime()});
                }
                if( sort[typeOfSort] == 2 ){
                    persons.sort( function( a, b ){ return b.date.getTime() - a.date.getTime()});
                }
            }
            if( typeOfSort == "serviceFunction" ){
                if( sort[typeOfSort] == 1 ){
                    persons.sort(function( a, b ){return a.serviceFunction.localeCompare(b.serviceFunction)});
                }
                if( sort[typeOfSort] == 2 ){
                    persons.sort(function( a, b ){return b.serviceFunction.localeCompare(a.serviceFunction)});
                }
            }
            if( typeOfSort == "experience" ){
                if( sort[typeOfSort] == 1 ){
                    persons.sort(function( a, b ){return a.experience-b.experience});
                }
                if( sort[typeOfSort] == 2 ){
                    persons.sort(function( a, b ){return b.experience-a.experience});
                }
            }
         
            for(var i = 0; i < persons.length;i++){
                  idClasses[persons[i].id] = $( "#" + persons[i].id ).attr("class");
            }
            
            for(var i = 0; i < persons.length;i++){
                    $(".data").get(i).replaceWith(persons[i].creatRow());
                    $( "#" + persons[i].id )[0] = persons[i].id;
                    $( "#" + persons[i].id ).attr("class",'').addClass(idClasses[persons[i].id]);

            }

        }
        function incrementSort(typeOfSort){
             if( sort[typeOfSort] == 2 ){
                sort[typeOfSort] = 0;
            }else{
                sort[typeOfSort]++;
            }
        }
        function Person(id,firstName, lastName, dateOfBirth, serviceFunction,experience){
            //variables
            this.id = id;
            this.firstName = firstName;
            this.lastName = lastName;
            this.dateOfBirth = dateOfBirth;
            this.serviceFunction = serviceFunction;
            this.experience = experience;   
            this.date;

            //konstruktor
                var day = "";
                var k = 0;
                var month = "";
                var year = "";
                var hour = "";
                var minute = "";
                for( var i = 0; i < dateOfBirth.length;i++){
                    if( k == 0 && dateOfBirth[i] != "."){
                        day += dateOfBirth[i];
                    }
                    if( k == 0 && dateOfBirth[i] == '.'){
                        k+=1;
                        i++;
                        if(day.length != 2 ){
                            day = "0" + day;
                        }
                        
                    }
                    if( k == 1 && dateOfBirth[i] != '.'){
                        month += dateOfBirth[i];
                    }
                    if( k == 1 && dateOfBirth[i] == '.'){
                        i++
                        k++;
                        if( month.length != 2 ){
                            month = "0" + month;
                        }
                        
                    }
                    
                    if( k == 2 && dateOfBirth[i] != ' '){
                        year += dateOfBirth[i];
                    }
                    if( k == 2 && dateOfBirth[i] == ' '){
                        k++;
                        i++;
                        if( year.length != 4 ){
                            year = "0" + year;
                        }
                    }
                    
                    if( k == 3 && dateOfBirth[i] != ':'){
                        hour += dateOfBirth[i];
                    }
                    if( k == 3 && dateOfBirth[i] == ':'){
                        k++;
                        i++;
                        if( hour.length != 2 ){
                            hour = "0" + hour;
                        }
                    }
                    
                     if( k == 4 ){
                        minute += dateOfBirth[i];
                    }
                    
                }
                
                var date = new Date();
                date.setFullYear(Number(year)-1,Number(month)-1,Number(day));
                date.setHours(Number(hour));
                date.setMinutes(Number(minute));
                
                this.date = date;
            
            this.creatRow = function(){
                
                var row = $(".data").clone().get(1);
                row.children[0].innerHTML = id;
                row.children[1].innerHTML = firstName;
                row.children[2].innerHTML = lastName;
                row.children[3].innerHTML = dateOfBirth;
                row.children[4].innerHTML = serviceFunction;
                row.children[5].innerHTML = experience;
                row.id = this.id;
                //if(this.fade == true){
              //      row.addClass("fadeBy");
               // }
                return row;
            }
        }
         
        </script>
    </body>
</html>